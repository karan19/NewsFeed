# NewsFeed Project - Cursor Rules

## Project Overview
This is a newsfeed application that consolidates data from multiple DynamoDB tables into a unified table using AWS Lambda and DynamoDB Streams.

## Monorepo Structure
This is an npm workspaces monorepo with:
- `packages/backend` - AWS CDK infrastructure and Lambda functions
- `packages/frontend` - Web application (coming soon)

## Tech Stack
- **Infrastructure**: AWS CDK (TypeScript)
- **Lambda Runtime**: Node.js with TypeScript
- **Database**: Amazon DynamoDB
- **Cloud Provider**: AWS
- **Package Manager**: npm workspaces

## Code Style & Conventions

### TypeScript
- Use strict TypeScript (`strict: true` in tsconfig)
- Prefer `interface` over `type` for object shapes
- Use explicit return types on functions
- Use `const` by default, `let` only when reassignment is needed
- Never use `any` - use `unknown` and type guards instead
- Use async/await over raw Promises

### Naming Conventions
- **Files**: kebab-case (e.g., `stream-handler.ts`, `unified-table.ts`)
- **Classes**: PascalCase (e.g., `NewsFeedStack`, `StreamProcessor`)
- **Functions/Variables**: camelCase (e.g., `processStreamEvent`, `tableArn`)
- **Constants**: SCREAMING_SNAKE_CASE (e.g., `MAX_BATCH_SIZE`, `TABLE_NAME`)
- **Interfaces**: PascalCase with `I` prefix optional (e.g., `UnifiedRecord` or `IUnifiedRecord`)

### CDK Conventions
- One stack per file in `packages/backend/lib/` directory
- Use constructs for reusable components
- Always add descriptions to CloudFormation resources
- Use environment variables for configuration, not hardcoded values
- Tag all resources with:
  - `Project: NewsFeed`
  - `Environment: Production`

### Lambda Conventions
- Each Lambda function in its own directory under `packages/backend/src/lambdas/`
- Shared utilities in `packages/backend/src/shared/`
- Keep handlers thin - business logic in separate modules
- Always handle DynamoDB Stream event types: INSERT, MODIFY, REMOVE
- Implement idempotent operations
- Use structured logging (JSON format)
- Include correlation IDs in logs

### DynamoDB Conventions
- Unified table primary key format: `{TABLE_NAME}#{record_id}`
- Always include `source_type`, `table_name`, `original_id` fields
- Use ISO 8601 format for timestamps
- Soft delete with `is_deleted` flag when mirroring REMOVE events

### Error Handling
- Use custom error classes for domain errors
- Always log errors with context before rethrowing
- Lambda should fail loudly (throw) to trigger DLQ/retry
- Validate input at Lambda handler entry point

### Testing
- Unit tests alongside source files (`*.test.ts`)
- Integration tests in `test/integration/`
- Use Jest as the test framework
- Mock AWS SDK calls in unit tests

### Git Conventions
- Conventional commits: `feat:`, `fix:`, `chore:`, `docs:`, `refactor:`
- Keep commits atomic and focused
- Branch naming: `feature/`, `fix/`, `chore/`

## Project Structure
```
NewsFeed/
├── packages/
│   ├── backend/                    # AWS CDK + Lambda
│   │   ├── bin/                    # CDK app entry point
│   │   ├── lib/                    # CDK stacks and constructs
│   │   ├── src/
│   │   │   ├── config/             # Source table configurations
│   │   │   ├── lambdas/            # Lambda function handlers
│   │   │   └── shared/             # Shared utilities and types
│   │   ├── scripts/                # CLI tools (backfill, etc.)
│   │   ├── test/                   # Test files
│   │   ├── cdk.json
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   └── frontend/                   # Web application (coming soon)
│       ├── src/
│       ├── package.json
│       └── tsconfig.json
│
├── package.json                    # Root package.json (workspaces)
├── tsconfig.json                   # Root tsconfig (references)
├── .cursorrules
├── .gitignore
├── Progress.md
├── TODO.md
└── ProjectDescription.md
```

## Common Commands

```bash
# From monorepo root
npm install                              # Install all dependencies
npm run build                            # Build all packages
npm run build:backend                    # Build backend only
npm run deploy                           # Deploy CDK stack
npm run backfill                         # Run backfill script
npm run backfill:dry                     # Dry run backfill

# From packages/backend
npm run build                            # Build backend
npx cdk deploy --profile codex           # Deploy to AWS
npx ts-node scripts/backfill.ts --help   # Backfill help
```

## AWS Resources Naming (Ada_Case)
- Stack: `NewsFeed-Stack` (CloudFormation requires hyphens, not underscores)
- Lambda: `NewsFeed_{Function_Name}` (e.g., `NewsFeed_Notes_Processor`)
- DynamoDB Table: `NewsFeed_Unified_Table`
- DynamoDB GSI: `GSI{N}_{Description}` (e.g., `GSI1_Source_Type_Created_At`)
- IAM Roles: Auto-generated by CDK with stack prefix

## Resource Tags
All resources are tagged with:
- `Project: NewsFeed`
- `Environment: Production`
